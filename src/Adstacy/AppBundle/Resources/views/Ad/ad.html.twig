{% set _comments = [] %}
{% if comments is defined %}
  {% set _comments = comments %}
{% else %}
  {% set _comments = ad.comments %}
{% endif %}
{% set commentsLength = _comments|length %}
{% set commentsLeft = ad.commentsCount - commentsLength %}
<div class="advert item" data-username="{{ ad.user.username }}">
  {% if ad.type == 'image' %}
    <div class="advert-img">
      {% set thumbnail, original = null, null %}
      {% set original = vich_uploader_asset(ad, 'image') %}
      {% set width = ad.imageWidth %}
      {% if ad.imageWidth >= thumb_width %}
        {% set thumbnail = original|imagine_filter('thumbnail') %}
        {% set width = thumb_width %}
      {% else %}
        {% set thumbnail = original %}
      {% endif %}
      <a href="{{ path('adstacy_app_ad_show', {id: ad.id}) }}">
        <img class="lazy {% if ad.imageWidth >= thumb_width %}full{% endif %}" src="{{ asset('bundles/adstacyapp/img/transparent.gif') }}"
          data-original="{{ thumbnail }}"
          data-high-res="{{ original }}"
          width="{{ width }}" height="{{ ad.imageHeight(width) }}">
      </a>
    </div>
  {% elseif ad.type == 'text' %}
    <div class="advert-text">
      <h3>{{ ad.title }}</h3>
      <p>{{ ad.description|raw }}</p>
    </div>
  {% elseif ad.type == 'youtube' %}
    <div class="advert-video" data-youtube-id="{{ ad.youtubeId }}">
      <a href="#">
        <img class="lazy" src="{{ asset('bundles/adstacyapp/img/transparent.gif') }}"
          data-original="http://img.youtube.com/vi/{{ ad.youtubeId }}/0.jpg"
          width="{{ thumb_width }}" height="{{ thumb_width * (9/16) }}"
        >
      </a>
      <div class="yt-player"></div>
    </div>
  {% endif %}

  <div class="advert-action clearfix">
    {% if app.user %}
      <div class="btn-group pull-left">
        {% set promoted = app.user.hasPromote(ad) %}
        <a href="{{ path('adstacy_app_ad_promote', {id: ad.id}) }}" class="btn btn-default btn-promote promote {% if promoted %}hide{% endif %}" title="Broadcast">
          <i class="icon icon-bullhorn"></i><span>broadcast</span>
        </a>
        <a href="{{ path('adstacy_app_ad_unpromote', {id: ad.id}) }}" class="btn btn-promote unpromote {% if not promoted %}hide{% endif %}" title="Unbroadcast">
          <i class="icon icon-bullhorn"></i><span>unbroadcast</span>
        </a>
      </div>
    {% endif %}
    <div class="btn-group pull-right">
      <a class="btn btn-default btn-share">
        <i class="icon icon-share"></i>
        <span>share</span>
      </a>
      <div class="btn-group">
        <a class="btn btn-default btn-option" data-toggle="dropdown">
          <i class="icon icon-ads"></i>
          <span>more</span>
        </a>
        <ul class="dropdown-menu pull-right">
          {% if view is not defined or (view is defined and view == true) %}
          <li><a href="{{ path('adstacy_app_ad_show', {id: ad.id}) }}"><i class="icon icon-eye"></i><span>{{"view"|trans}}</span></a></li>
          {% endif %}
          {% if app.user %}
            {% if app.user == ad.user %}
              <li><a href="{{ path('adstacy_app_ad_edit', {id: ad.id}) }}"><span class="owner-action-label">{{ "edit"|trans }}</span></a></li>
              <li><a data-toggle="modal" data-target="#confirm-modal"><span class="owner-action-label">{{ "delete"|trans }}</span></a></li>
            {% else %}
              <li><a href="{{ path('adstacy_app_ad_report', {id: ad.id}) }}" class="report"><span>{{"report"|trans}}</span></a></li>
            {% endif %}
          {% endif %}
          {% if is_granted('ROLE_SUPER_ADMIN') %}
            {% if ad.active %}
              <a href="{{ path('adstacy_admin_ad_block', {id: ad.id}) }}">Block</a>
            {% else %}
              <a href="{{ path('adstacy_admin_ad_unblock', {id: ad.id}) }}">Unblock</a>
            {% endif %}
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  <div class="advert-action-content">
    <div class="advert-share btn-group btn-group-justified">
      {% set adUrl = url('adstacy_app_ad_show', {id: ad.id}) %}
      {% set tags = ad.tags|join(',') %}
      {% set desc = '' %}
      {% if ad.type == 'text' %}
        {% set desc = ad.title %}
      {% else %}
        {% set desc = ad.description|striptags|slice(0, 160) %}
      {% endif %}
      {% set twitterUrl = "https://twitter.com/share?url=#{adUrl}&text=#{desc}&hashtags=#{tags}" %}
      {% set facebookUrl = "https://www.facebook.com/sharer/sharer.php?u=#{adUrl}" %}

      <input type="text" readonly="readonly" class="url" value="{{ url('adstacy_app_ad_show', {id: ad.id}) }}">
      <a href="{{ facebookUrl }}" class="btn btn-facebook btn-social facebook-share"><i class="icon icon-facebook"></i><span>share</span></a>
      <a href="{{ twitterUrl }}" class="btn btn-twitter btn-social tweet"><i class="icon icon-twitter twitter-share"></i><span>tweet</span></a>
    </div>
  </div>

 {#  <div class="advert-action-content">
    {% set adUrl = url('adstacy_app_ad_show', {id: ad.id}) %}
    {% set tags = ad.tags|join(',') %}
    {% set desc = remove_hashtag(ad.description) %}
    {% set twitterUrl = "https://twitter.com/share?url=#{adUrl}&text=#{desc}&hashtags=#{tags}" %}
    {% set facebookUrl = "https://www.facebook.com/sharer/sharer.php?u=#{adUrl}" %}
    <div class="advert-share btn-group btn-group-justified">
      <input type="text" readonly="readonly" class="url" value="{{ url('adstacy_app_ad_show', {id: ad.id}) }}">
      <a href="{{ facebookUrl }}" class="btn btn-facebook facebook-share"><i class="icon icon-facebook"></i>Share</a>
      <a href="{{ twitterUrl }}" class="btn btn-twitter tweet"><i class="icon icon-twitter twitter-share"></i>Tweet</a>
    </div>
  </div> #}

  <div class="advert-detail">
    <div class="advert-user clearfix">
      {% set user = ad.user %}
      <div class="profile-picture">
        <img class="profile-picture-img" src="{{ profile_pic(user) }}" alt="{{ user.username }}" width="48" height="48">
      </div>
      <div class="user-desc">
        <a class="realname" href="{{ path('adstacy_app_user_profile', {username: user.username}) }}">{{ user.realName }} <span class="username">@{{ user.username }}</span></a>
      </div>
      <div class="advert-date">
        <time class="timeago" datetime="{{ ad.created|date('c') }}">{{ ad.created|date('F j, Y') }}</span>
      </div>
    </div>
    {% if ad.type != 'text' %}
      <p class="advert-desc">{{ parse_url(ad.description) }}</p>
    {% endif %}
    <div class="advert-tags">
      {% for tag in ad.tags %}
        <a href="{{ path('adstacy_app_search', {q: tag}) }}">#{{tag}}</a>
      {% endfor %}
    </div>
  </div>

  <div class="advert-comments-container">
    {% if commentsLeft > 0 %}
      {% set lastId = _comments[0].id %}
      <div class="load-more-comments">
        <a href="javascript:;" data-href="{{ path('adstacy_api_ad_comments', {id: ad.id, until: lastId}) }}">
          {{"comment.load_more"|trans({'%count%': commentsLeft})|raw}}
        </a>
      </div>
    {% endif %}

    <div class="advert-comments">
      {% for comment in _comments %}
        <div class="comment media" data-id="{{ comment.id }}">
          <div class="pull-left">
            <img src="{{ profile_pic(comment.user) }}" alt="" width="32" height="32" class="media-object">
          </div>
          <div class="media-body">
            <p class="media-heading">
              <a class="realname" href="{{ path('adstacy_app_user_profile', {username: comment.user.username}) }}">{{ comment.user.realName }}
                <span class="username">@{{ comment.user.userName }}</span>
              </a>
              &middot; <time class="timeago" datetime="{{ comment.created|date('c') }}">{{ comment.created|date('F j, Y') }}</time>
              {% if app.user and (app.user == comment.user or app.user == comment.user) %}
                <a href="javascript:;" data-href="{{ path('adstacy_app_ad_comment_delete', {id: comment.id}) }}" class="pull-right delete-comment">&times;</a>
              {% endif %}
            </p>
            <p>{{ comment.content }}</p>
          </div>
        </div>
      {% endfor %}

      {% if app.user %}
        <div class="comment">
          <div class="pull-left">
            <img src="{{ profile_pic(app.user) }}" alt="" width="32" height="32">
          </div>
          <div class="comment-body">
            <form action="{{ path('adstacy_app_ad_comment', {id: ad.id}) }}" method="post">
              <textarea name="comment[content]" required="required" class="comment-box" placeholder="{{"form_comment.placeholders.content"|trans}}"></textarea>
              <input type="submit" value="{{"comment"|trans}}" class="hide">
            </form>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

