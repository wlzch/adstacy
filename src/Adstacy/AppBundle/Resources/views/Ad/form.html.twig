{% extends 'AdstacyAppBundle::layout.html.twig' %}

{% block stylesheets %}
  {{ parent() }}
  {% stylesheets filter='cssrewrite, uglifycss'
    'bundles/adstacyapp/less/layout/create_ad.less'
    'bundles/adstacyapp/less/bootstrap-tagsinput.less'
  %}
    <link href="{{ asset_url }}" type="text/css" rel="stylesheet">
  {% endstylesheets %}
{% endblock %}

{% block head_scripts %}
  {{ parent() }}
  {% javascripts filter='uglifyjs2'
    '@AdstacyAppBundle/Resources/public/js/FileAPI.min.js'
    '@AdstacyAppBundle/Resources/public/js/FileAPI.exif.js'
  %}
    <script src="{{ asset_url }}" type="text/javascript"></script>
  {% endjavascripts %}
{% endblock %}

{% block content %}
  {% set data = form.vars.data %}
  <div id="create-advert" class="panel panel-default">
    <div class="panel-body clearfix">
      {{ form_start(form, {attr: {class: 'submit-disable'}}) }}
      {{ form_errors(form) }}
      {{ form_label(form.image) }}
      <div id="create-advert-image">
        {{ form_widget(form.image) }}
      </div>

      <div id="create-advert-desc">
        <div class="clearfix">
          {{ form_label(form.description) }}
          {{ form_widget(form.description) }}
          <div id="chars-left-box">
            {{ "form_ad.characters_left"|trans({'%left%': desc_length - (data.description|length)})|raw }}
          </div>
        </div>
        <div class="clearfix">
          {{ form_label(form.tags) }}
          <div>
            {{ form_widget(form.tags) }}
          </div>
        </div>

        <button id="show-long-desc-btn" type="button" class="btn btn-info btn-block">{{"form_ad.content_trigger"|trans}}</button>
        <div id="create-advert-content" {% if not data.content %}class="hide"{% endif %}>
          {{ form_widget(form.content) }}
        </div>

        {{ form_widget(form.save, {
            attr: {
              'class': 'form-control btn btn-primary submit-disable-btn',
              'data-disable-text': "saving"|trans
            }
          })
        }}

        {{ form_rest(form) }}
        {{ form_end(form) }}

        {{ elfinder_tinymce_init4() }}
        {{ tinymce_init() }}
      </div>
    </div>
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent()  }}
  {% javascripts filter='uglifyjs2'
    '@AdstacyAppBundle/Resources/public/js/bootstrap-tagsinput.js'
  %}
    <script src="{{ asset_url }}" type="text/javascript"></script>
  {% endjavascripts %}
  <script type="text/javascript">
    $(function() {
      $('#{{ form.tags.vars.id }}').tagsinput({
        itemText: function(item) {
          if (item && item.length > 0) {
            if (item[0] != '#') return '#'+item;
            return item;
          }
          return false;
        }
      });
      var $trigger = $('#show-long-desc-btn');
      var $content = $('#create-advert-content');
      var $charsLeft = $('#chars-left');
      var $desc = $('#{{ form.description.vars.id }}');
      $trigger.click(function() {
        $content.toggleClass('hide');
      });
      var checkCharsLeft = function() {
        var val = $desc.val();
        if (val.length > {{ desc_length}} ) {
          if (val.length == {{ desc_length }} + 1) {
            return false;
          }

          $desc.val(val.substring(0, {{ desc_length }} - 1));
          return false;
        }
        $charsLeft.text({{ desc_length }} - val.length);
      }
      $desc.keyup(checkCharsLeft);
      //$desc.keypress(checkCharsLeft);
    });
  </script>
{% endblock %}
