{% extends 'AdstacyAppBundle::layout.html.twig' %}

{% block title %}{{ ad.description }} | Adstacy{%endblock %}

{% block meta_keywords %}{{ ad.tags|join(',') }}{% endblock %}

{% block content %}
  {% set user = ad.user %}

  <div id="ad-detail-container">
    <div id="ad-detail-content" class="pull-left">
      <div class="panel panel-default">
        <div class="panel-body toolbar">
          {% if app.user %}
            <div class="btn-group btn-group-sm">
              {% set promoted = app.user.hasPromote(ad) %}
              <a href="{{ path('adstacy_app_ad_unpromote', {id: ad.id}) }}" class="btn btn-primary btn-promote unpromote {% if not promoted %}hide{% endif %}"><span class="icon-bullhorn"></span> Unpromote</a>
              <a href="{{ path('adstacy_app_ad_promote', {id: ad.id}) }}" class="btn btn-primary btn-promote promote {% if promoted %}hide{% endif %}"><span class="icon-bullhorn"></span> Promote</a>
              <button type="button" class="btn btn-default promotes-count"><span class="promotes-count">{{ ad.promoteesCount }}</span></button>
            </div>
          {% else %}
            <a class="btn btn-default btn-sm">{{ ad.promoteesCount }} promotes</a>
          {% endif %}

          {% set adUrl = url('adstacy_app_ad_show', {id: ad.id}) %}
          {% set tags = ad.tags|join(',') %}
          {% set desc = remove_hashtag(ad.description) %} {# remove hashtags because # character is fragment in url #}
          {% set twitterUrl = "https://twitter.com/share?url=#{adUrl}&text=#{desc}&hashtags=#{tags}" %}
          {% set facebookUrl = "https://www.facebook.com/sharer/sharer.php?u=#{adUrl}" %}

          <a href="{{ twitterUrl }}" class="tweet btn btn-twitter btn-sm">
            <span aria-hidden="true" data-icon="&#xe002;"></span> Twitter
          </a>
          <a href="{{ facebookUrl }}" class="facebook-share btn btn-facebook btn-sm">
            <span aria-hidden="true" data-icon="&#xe003;"></span> Facebook
          </a>
          {% if app.user == user %}
            <div class="btn-group btn-group-sm pull-right">
              <a href="{{ path('adstacy_app_ad_edit', {id: ad.id}) }}" class="btn btn-default">{{"edit"|trans}}</a>
              <a href="#" data-toggle="modal" data-target="#confirm-modal" class="btn btn-primary">{{"delete"|trans}}</a>
            </div>
          {% endif %}
        </div>

        <div class="panel-body">
          <p class="lead">{{ parse_url(parse_hashtag(ad.description)) }}</p>
        </div>

        <div class="text-center">
          {% set src = vich_uploader_asset(ad, 'image') %}
          <img src="{{ src }}" alt="{{ ad.description }}">
        </div>
      </div>

      {% if ad.content %}
        <div class="panel panel-default">
          <div class="panel-body">
            {{ ad.content|raw }}
          </div>
        </div>
      {% endif %}
    </div>

    <div id="ad-detail-sidebar" class="pull-left">
      <div class="panel panel-default">
        <div class="panel-body clearfix">
          {% include 'AdstacyAppBundle:User:user_mini.html.twig' with { user: user, text: '2 minutes ago' } %}
        </div>
        {% if user.about %}
        <div class="panel-body">
          <p>{{ user.about }}</p>
        </div>
        {% endif %}
        <div class="thumb-container">
          {% for adByUser in adsByUser %}
            <div class="thumb">
              <img src="{{ vich_uploader_asset(adByUser, 'image')|imagine_filter('mini_thumb')}}"
                width="{{ mini_thumb_size }}px" height="{{ mini_thumb_size }}px">
            </div>
          {% endfor %}
        </div>

        <div class="panel-body">
          <a href="{{ path('adstacy_app_user_profile', {username: user.username}) }}" class="btn btn-default btn-block" style="margin-bottom: 10px;">more ads</a>
          {% if app.user and app.user != user %}
            {% set hasFollow = app.user.hasFollowUser(user) %}
            <a href="{{ path('adstacy_app_user_follow', {username: ad.user.username}) }}" class="btn btn-primary btn-block btn-follow follow-user {% if hasFollow %}hide{% endif %}">Follow</a>
            <a href="{{ path('adstacy_app_user_unfollow', {username: ad.user.username}) }}" class="btn btn-primary btn-block btn-follow unfollow-user {% if not hasFollow %}hide{% endif %}">Unfollow</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="confirm-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">{{ "ads.delete.confirm_title"|trans }}</h4>
        </div>
        <div class="modal-body">
          <p>{{ "ads.delete.confirm_message"|trans }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">{{ "cancel"|trans }}</button>
          <a href="{{ path('adstacy_app_ad_delete', {id: ad.id}) }}" class="btn btn-primary">{{ "ads.delete.button"|trans }}</a>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script type="text/javascript">
    $(function() {
      $('#ad-detail-container').ajaxlink('promote_single');
      $('#ad-detail-sidebar').ajaxlink('follow_user');
    });
  </script>
{% endblock %}
